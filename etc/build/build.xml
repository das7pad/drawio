<?xml version="1.0"?>
<project basedir="." default="all">
	
	<property file="build.properties.local" />
	<property file="build.properties" />
	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpath="${jscompiler}" />

	<target name="merge">
	</target>

	<target name="app">
		<concat destfile="${basedir}/base-viewer.min.js" fixlastline="yes" append="no">
			<filelist dir="${build.dir}" files="constants.min.js,client.min.js,base-viewer.in.min.js"/>
			<filelist dir="${war.dir}/js/spin" files="spin.min.js"/>
			<filelist dir="${war.dir}/js/sanitizer" files="sanitizer.min.js"/>
			<filelist dir="${war.dir}/js/deflate" files="pako.min.js"/>
    	</concat>

		<concat destfile="${war.dir}/js/viewer.min.js" fixlastline="yes" append="no">
			<filelist dir="${basedir}" files="base-viewer.min.js"/>
			<filelist dir="${build.dir}" files="init-viewer.min.js"/>
    		</concat>

		<delete file="${war.dir}/js/extensions.min.js"/>

		<jscomp compilationLevel="simple" debug="false" forceRecompile="true" output="${basedir}/base.in.min.js">
			<sources dir="${war.dir}/js/diagramly">
				<file name="DrawioFile.js" />
				<file name="LocalFile.js" />
				<file name="LocalLibrary.js" />
				<file name="StorageFile.js" />
				<file name="StorageLibrary.js" />
				<file name="UrlLibrary.js" />
				<file name="Dialogs.js" />
				<file name="Editor.js" />
				<file name="EditorUi.js" />
				<file name="DiffSync.js" />
				<file name="Settings.js" />
				<file name="DrawioFileSync.js" />
				<file name="App.js" />
				<file name="Menus.js" />
				<file name="Pages.js" />
				<file name="Trees.js" />
				<file name="Minimal.js" />
				<file name="DistanceGuides.js" />
			</sources>
				
			<sources dir="${build.dir}">
				<file name="Graph-Stylesheet.js" />
			</sources>
		</jscomp>
			
		<concat destfile="${basedir}/base.min.js" fixlastline="yes" append="no">
			<filelist dir="${war.dir}/js/spin" files="spin.min.js"/>
			<filelist dir="${war.dir}/js/sanitizer" files="sanitizer.min.js"/>
			<filelist dir="${war.dir}/js/cryptojs" files="aes.min.js"/>
			<filelist dir="${war.dir}/js/deflate" files="pako.min.js"/>
			<filelist dir="${basedir}" files="base.in.min.js"/>
			<filelist dir="${build.dir}" files="sidebar.min.js,grapheditor.min.js,client.min.js"/>
    	</concat>
		<delete file="${basedir}/base.in.min.js"/>

		<loadfile property="version" srcFile="../../VERSION"/>
		<replace file="${basedir}/base.min.js" token="@DRAWIO-VERSION@" value="${version}"/>
		
		<jscomp compilationLevel="simple" debug="false" forceRecompile="true" output="${war.dir}/js/extensions.min.js">
			<sources dir="${war.dir}/js/diagramly">
				<file name="Extensions.js" />
			</sources>
			<sources dir="${war.dir}/js/diagramly/vsdx">
				<file name="VsdxExport.js" />
				<file name="mxVsdxCanvas2D.js" />
				<file name="bmpDecoder.js" />
				<file name="importer.js" />
			</sources>
			<sources dir="${war.dir}/js/diagramly/graphml">
				<file name="mxGraphMlCodec.js" />
			</sources>
		</jscomp>
		<concat destfile="${war.dir}/js/extensions.min.js" fixlastline="yes" append="yes">
	    		<fileset dir="${war.dir}/js/jszip" includes="**/*.min.js"/>
	    	</concat>

		<jscomp compilationLevel="simple" debug="false" forceRecompile="true" output="${basedir}/app.in.min.js">
			<sources dir="${war.dir}/js/diagramly">
				<file name="DrawioFile.js" />
				<file name="LocalFile.js" />
				<file name="LocalLibrary.js" />
				<file name="StorageFile.js" />
				<file name="StorageLibrary.js" />
				<file name="UrlLibrary.js" />
				<file name="Dialogs.js" />
				<file name="Editor.js" />
				<file name="EditorUi.js" />
				<file name="DiffSync.js" />
				<file name="Settings.js" />
				<file name="DrawioFileSync.js" />
			</sources>
				
			<sources dir="${build.dir}">
				<file name="Graph-Stylesheet.js" />
			</sources>

			<sources dir="${war.dir}/js/diagramly/util">
				<file name="mxAsyncCanvas.js" />
				<file name="mxJsCanvas.js" />
			</sources>

			<sources dir="${war.dir}/js/diagramly">
				<file name="DrawioClient.js" />
				<file name="DrawioUser.js" />
				<file name="DriveFile.js" />
				<file name="DriveLibrary.js" />
				<file name="DriveClient.js" />
				<file name="DropboxFile.js" />
				<file name="DropboxLibrary.js" />
				<file name="DropboxClient.js" />
				<file name="OneDriveFile.js" />
				<file name="OneDriveLibrary.js" />
				<file name="OneDriveClient.js" />
				<file name="GitHubFile.js" />
				<file name="GitHubLibrary.js" />
				<file name="GitHubClient.js" />
				<file name="TrelloFile.js" />
				<file name="TrelloLibrary.js" />
				<file name="TrelloClient.js" />
			</sources>
			
			<sources dir="${war.dir}/js/diagramly">
				<file name="App.js" />
				<file name="Menus.js" />
				<file name="Pages.js" />
				<file name="Trees.js" />
				<file name="Minimal.js" />
				<file name="DistanceGuides.js" />
			</sources>
		</jscomp>

		<concat destfile="${war.dir}/js/app.min.js" fixlastline="yes" append="no">
			<filelist dir="${war.dir}/js/spin" files="spin.min.js"/>
			<filelist dir="${war.dir}/js/sanitizer" files="sanitizer.min.js"/>
			<filelist dir="${war.dir}/js/cryptojs" files="aes.min.js"/>
			<filelist dir="${war.dir}/js/deflate" files="pako.min.js"/>
			<filelist dir="${basedir}" files="app.in.min.js"/>
			<filelist dir="${build.dir}" files="sidebar.min.js,grapheditor.min.js,client.min.js"/>
    	</concat>

		<replace file="${war.dir}/js/app.min.js" token="@DRAWIO-VERSION@" value="${version}"/>

		<delete file="${basedir}/app.in.min.js"/>
	</target>

	<target name="all">
	</target>

	<!-- ================== Stand-alone war creation ============================= -->

	<path id="javac.class.path">
		<fileset dir="${war.dir}/WEB-INF/lib" />
	</path>

	<target name="javac" description="Java compilation">
		<mkdir dir="${javac.dir}"/>
		<javac includeantruntime="false" srcdir="${src.dir}" excludes="**/EmbedServlet2.java" destdir="${javac.dir}">
			<classpath refid="javac.class.path" />
		</javac>
		<copy todir="${javac.dir}" file="${src.dir}/log4j.properties" />
	</target>

	<target name="clean" description="Cleans build directories">
		<delete failonerror="false">
			<fileset dir="${javac.dir}">
			</fileset>
			<fileset dir="${build.dir}">
			</fileset>
		</delete>
		<delete file="${basedir}/base.min.js"/>
		<delete file="${basedir}/base-viewer.min.js"/>
	</target>
	
	<target name="war" description="Create the stand-alone war file">
		<zip destfile="${build.dir}/${war.name}" basedir="${war.dir}" >
		</zip>
	</target>

</project>
